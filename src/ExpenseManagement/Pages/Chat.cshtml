@page
@model ChatModel
@{
    ViewData["Title"] = "AI Chat";
}

<div class="card">
    <h2>üí¨ AI Chat Assistant</h2>

    @if (!Model.IsConfigured)
    {
        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 20px; margin: 20px 0;">
            <h3 style="color: #856404; margin-bottom: 10px;">üîß AI Chat Not Available</h3>
            <p style="color: #856404; margin-bottom: 10px;">
                AI Chat is not available yet. To enable it, redeploy using the <code>-DeployGenAI</code> switch.
            </p>
            <p style="color: #856404; font-size: 0.9rem;">
                The AI chat feature requires Azure OpenAI resources to be deployed. Once deployed, you'll be able to ask questions about expenses, create new expenses, and approve expenses using natural language.
            </p>
        </div>
    }
    else
    {
        <div id="chatContainer" style="background: #f8f9fa; border-radius: 8px; padding: 20px; min-height: 400px; max-height: 600px; overflow-y: auto; margin: 20px 0;">
            <div id="messages"></div>
        </div>

        <form id="chatForm" style="display: flex; gap: 10px;">
            <input type="text" id="messageInput" class="form-control" placeholder="Ask me anything about expenses..." required />
            <button type="submit" class="btn btn-primary" style="white-space: nowrap;">Send üì§</button>
        </form>
    }
</div>

@if (Model.IsConfigured)
{
    @section Scripts {
        <script>
            const messagesDiv = document.getElementById('messages');
            const chatForm = document.getElementById('chatForm');
            const messageInput = document.getElementById('messageInput');
            const chatHistory = [];

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = messageInput.value.trim();
                if (!message) return;

                // Add user message to chat
                addMessage('user', message);
                chatHistory.push({ role: 'user', content: message });
                messageInput.value = '';

                // Show loading indicator
                const loadingId = 'loading-' + Date.now();
                addMessage('assistant', '...', loadingId);

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message, history: chatHistory })
                    });

                    const data = await response.json();

                    // Remove loading indicator
                    document.getElementById(loadingId)?.remove();

                    if (data.success) {
                        addMessage('assistant', data.message);
                        chatHistory.push({ role: 'assistant', content: data.message });
                    } else {
                        addMessage('assistant', '‚ùå Error: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    document.getElementById(loadingId)?.remove();
                    addMessage('assistant', '‚ùå Error: ' + error.message);
                }
            });

            function addMessage(role, content, id) {
                const messageDiv = document.createElement('div');
                if (id) messageDiv.id = id;
                messageDiv.style.cssText = `
                    margin-bottom: 15px;
                    padding: 15px;
                    border-radius: 8px;
                    ${role === 'user' 
                        ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-left: 60px;' 
                        : 'background: white; margin-right: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);'}
                `;

                const formattedContent = formatMarkdown(escapeHtml(content));
                messageDiv.innerHTML = `<strong>${role === 'user' ? 'You' : 'ü§ñ AI Assistant'}:</strong><div style="margin-top: 8px;">${formattedContent}</div>`;
                messagesDiv.appendChild(messageDiv);
                messagesDiv.parentElement.scrollTop = messagesDiv.parentElement.scrollHeight;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function formatMarkdown(text) {
                // Convert bold
                text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                
                // Convert bullet lists
                text = text.replace(/^- (.+)$/gm, '<li>$1</li>');
                if (text.includes('<li>')) {
                    text = text.replace(/(<li>.*<\/li>)/s, '<ul style="margin: 10px 0; padding-left: 20px;">$1</ul>');
                }
                
                // Convert numbered lists
                text = text.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
                
                // Convert line breaks
                text = text.replace(/\n/g, '<br>');
                
                return text;
            }
        </script>
    }
}
