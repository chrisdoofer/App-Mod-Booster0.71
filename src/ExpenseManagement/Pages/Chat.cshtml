@page
@model ExpenseManagement.Pages.ChatModel
@{
    ViewData["Title"] = "Chat";
}

<div class="row">
    <div class="col-12">
        <h1>AI Chat Assistant</h1>
        <p class="text-muted">Ask questions about expenses or perform actions using natural language.</p>
    </div>
</div>

@if (!Model.IsConfigured)
{
    <div class="alert alert-info">
        <h4 class="alert-heading">AI Chat Not Available</h4>
        <p>The AI Chat feature is not currently configured. To enable it:</p>
        <ol>
            <li>Redeploy the infrastructure using the <code>-DeployGenAI</code> switch:</li>
            <li><code>.\deploy-infra\deploy.ps1 -ResourceGroup "your-rg" -Location "uksouth" -DeployGenAI</code></li>
        </ol>
        <hr>
        <p class="mb-0">This will deploy Azure OpenAI and configure the chat service.</p>
    </div>
}
else
{
    <div class="card" style="height: 600px;">
        <div class="card-header">
            <span class="badge bg-success">Connected</span> Chat with Expense AI
        </div>
        <div class="card-body d-flex flex-column">
            <!-- Chat Messages -->
            <div id="chatMessages" class="flex-grow-1 overflow-auto mb-3 p-3 bg-light rounded" style="min-height: 400px;">
                <div class="chat-message assistant">
                    <div class="message-content bg-white p-3 rounded shadow-sm mb-2">
                        <strong>AI Assistant:</strong><br>
                        Hello! I'm your expense management assistant. I can help you:
                        <ul class="mb-0 mt-2">
                            <li>View and filter expenses</li>
                            <li>Create new expenses</li>
                            <li>Approve or reject expenses</li>
                            <li>Get dashboard statistics</li>
                        </ul>
                        How can I help you today?
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <form id="chatForm" class="d-flex gap-2">
                <input type="text" id="messageInput" class="form-control" 
                       placeholder="Type your message..." autocomplete="off" />
                <button type="submit" class="btn btn-primary" id="sendButton">
                    Send
                </button>
            </form>
        </div>
    </div>

    @section Scripts {
        <script>
            const chatMessages = document.getElementById('chatMessages');
            const chatForm = document.getElementById('chatForm');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            let conversationHistory = [];

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const message = messageInput.value.trim();
                if (!message) return;

                // Add user message to UI
                addMessage('user', message);
                messageInput.value = '';
                
                // Disable input while processing
                messageInput.disabled = true;
                sendButton.disabled = true;
                sendButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                try {
                    const response = await fetch('/api/chat/message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            history: conversationHistory
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        addMessage('assistant', result.data);
                        conversationHistory.push({ role: 'user', content: message });
                        conversationHistory.push({ role: 'assistant', content: result.data });
                        
                        // Keep history manageable
                        if (conversationHistory.length > 20) {
                            conversationHistory = conversationHistory.slice(-20);
                        }
                    } else {
                        addMessage('error', result.message || 'An error occurred');
                    }
                } catch (error) {
                    addMessage('error', 'Failed to send message: ' + error.message);
                } finally {
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    sendButton.innerHTML = 'Send';
                    messageInput.focus();
                }
            });

            function addMessage(role, content) {
                const div = document.createElement('div');
                div.className = `chat-message ${role} mb-2`;
                
                const isUser = role === 'user';
                const isError = role === 'error';
                
                // Format the content (handle markdown-like formatting)
                let formattedContent = escapeHtml(content);
                formattedContent = formattedContent
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>')
                    .replace(/^(\d+)\. /gm, '<br>$1. ')
                    .replace(/^- /gm, '<br>â€¢ ');
                
                div.innerHTML = `
                    <div class="message-content p-3 rounded shadow-sm ${isUser ? 'bg-primary text-white ms-auto' : isError ? 'bg-danger text-white' : 'bg-white'}" 
                         style="max-width: 80%; ${isUser ? 'margin-left: auto;' : ''}">
                        <strong>${isUser ? 'You' : isError ? 'Error' : 'AI Assistant'}:</strong><br>
                        ${formattedContent}
                    </div>
                `;
                
                chatMessages.appendChild(div);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        </script>
    }
}

<style>
    .chat-message {
        display: flex;
    }
    .chat-message.user {
        justify-content: flex-end;
    }
    .message-content {
        word-wrap: break-word;
    }
</style>
