@page
@model ExpenseManagement.Pages.ChatModel
@{
    ViewData["Title"] = "AI Chat Assistant";
}

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-chat-dots"></i> AI Chat Assistant
        </h1>
    </div>
</div>

@if (!Model.IsConfigured)
{
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="alert alert-info">
                <h4 class="alert-heading"><i class="bi bi-info-circle"></i> AI Chat Not Configured</h4>
                <p>
                    The AI chat feature requires Azure OpenAI and AI Search resources to be deployed.
                    These resources were not deployed during the infrastructure setup.
                </p>
                <hr>
                <p class="mb-0">
                    <strong>To enable AI chat:</strong> Redeploy the infrastructure using the <code>-DeployGenAI</code> switch:
                </p>
                <pre class="mt-2 mb-0"><code>.\deploy-infra\deploy.ps1 -ResourceGroup "your-rg" -Location "uksouth" -DeployGenAI</code></pre>
            </div>
        </div>
    </div>
}
else
{
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-robot"></i> Chat with AI about your expenses
                    </h5>
                </div>
                <div class="card-body" style="height: 500px; overflow-y: auto;" id="chatContainer">
                    <div id="chatMessages">
                        <!-- Messages will be added here -->
                        <div class="mb-3">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <i class="bi bi-robot fs-3 text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="alert alert-secondary mb-0">
                                        <p class="mb-0">Hello! I'm your AI assistant for expense management. I can help you with:</p>
                                        <ul class="mb-0 mt-2">
                                            <li>View all expenses or filter by status</li>
                                            <li>Create new expenses</li>
                                            <li>Get expense summaries</li>
                                            <li>List categories and users</li>
                                        </ul>
                                        <p class="mb-0 mt-2">Try asking me something like "Show me all submitted expenses" or "Create an expense for £50 for travel".</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <form id="chatForm">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." autocomplete="off" />
                            <button type="submit" class="btn btn-primary" id="sendButton">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    @if (Model.IsConfigured)
    {
        <script>
            const chatMessages = document.getElementById('chatMessages');
            const chatContainer = document.getElementById('chatContainer');
            const chatForm = document.getElementById('chatForm');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const conversationHistory = [];

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const message = messageInput.value.trim();
                if (!message) return;

                // Disable input while processing
                messageInput.disabled = true;
                sendButton.disabled = true;

                // Add user message to chat
                addMessage('user', message);
                messageInput.value = '';

                // Show loading indicator
                const loadingId = 'loading-' + Date.now();
                addMessage('assistant', '<span class="spinner-border spinner-border-sm" role="status"></span> Thinking...', loadingId);

                try {
                    // Send to server
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            history: conversationHistory
                        })
                    });

                    const data = await response.json();

                    // Remove loading indicator
                    document.getElementById(loadingId)?.remove();

                    // Add assistant response
                    addMessage('assistant', data.response);

                    // Update conversation history
                    conversationHistory.push({ role: 'user', content: message });
                    conversationHistory.push({ role: 'assistant', content: data.response });

                    // Keep only last 10 messages to avoid token limits
                    if (conversationHistory.length > 20) {
                        conversationHistory.splice(0, 2);
                    }
                } catch (error) {
                    // Remove loading indicator
                    document.getElementById(loadingId)?.remove();
                    
                    addMessage('assistant', 'Sorry, I encountered an error: ' + error.message);
                } finally {
                    // Re-enable input
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    messageInput.focus();
                }
            });

            function addMessage(role, content, id) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'mb-3';
                if (id) messageDiv.id = id;

                const icon = role === 'user' 
                    ? '<i class="bi bi-person-circle fs-3 text-success"></i>'
                    : '<i class="bi bi-robot fs-3 text-primary"></i>';

                const alertClass = role === 'user' ? 'alert-success' : 'alert-secondary';
                
                // Format content - convert markdown-style formatting to HTML
                const formattedContent = formatContent(content);

                messageDiv.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0">
                            ${icon}
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="alert ${alertClass} mb-0">
                                ${formattedContent}
                            </div>
                        </div>
                    </div>
                `;

                chatMessages.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function formatContent(content) {
                // Escape HTML first
                const div = document.createElement('div');
                div.textContent = content;
                let escaped = div.innerHTML;

                // Convert markdown-style formatting
                escaped = escaped
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                    .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic
                    .replace(/\n\n/g, '</p><p>') // Paragraphs
                    .replace(/\n- /g, '<br>• ') // Bullet points
                    .replace(/\n(\d+)\. /g, '<br>$1. '); // Numbered lists

                return '<p>' + escaped + '</p>';
            }

            // Focus on input when page loads
            messageInput.focus();
        </script>
    }
}
